@using MVC.Models.Datas
@{
    Layout = "~/Views/Shared/_Layout.cshtml";

}
@model CoinMarketCapItem


@section customScripts {

        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
        <script type="text/javascript" charset = "utf8" src = "https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js" ></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">
 
    <script>
                // DataTable başlatma
                var dataTable = $('#eventDataTable').DataTable({
            "columnDefs": [
                { "type": "html", "targets": 0 },
                {   
                    "targets": 4, // Dördüncü sütun
                    "data": null, // Veri yok
                    "defaultContent": "<button class='btn btn-info btn-sm'>Detay</button>", // Buton ekleme
                    "orderable": false // Sıralanabilir değil
                }
            ]
             });

        // 'Detay' butonuna tıklama olayı

        $('#eventDataTable tbody').on('click', '.btn-info', function (e) {
            e.stopPropagation();
            var data = dataTable.row($(this).parents('tr')).data();
            // Modalı aç ve içeriği güncelle
            $('#dataModalDetay').modal('show');
            // Burada modal içerisindeki DataTable'ı güncellemek için gerekli işlemleri yapabilirsiniz
        });

    </script>
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Market</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link href="~/css/market.css" rel="stylesheet" />
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .increase {
            color: green;
        }

        .decrease {
            color: red;
        }
    </style>

</head>
<body>
 

    <div class="container mt-5 transparent">
        <label for="pairSelect">Parite Seç:</label>
        <select id="pairSelect">
            <option value="">All</option>
            <option value="USDT">USDT</option>
            <option value="ETH">ETH</option>
            <option value="BTC">BTC</option>
        </select>
        <table id="eventDataTable" class="display transparent">
            <thead>
                <tr>
                    <th>Sembol</th>
                    <th>Fiyat Değişimi</th>
                    <th>Fiyat Değişimi (%)</th>
                    <th>Fiyat</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>


    <!-- Alarm Kur Modalı -->
    @* <div class="modal fade" id="alarmModal" tabindex="-1" role="dialog" aria-labelledby="alarmModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alarmModalLabel">Alarm Kur</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="alarmForm">
                        <div class="form-group">
                            <label for="priceInput">Fiyat</label>
                            <input type="number" class="form-control" id="priceInput" placeholder="Fiyat giriniz">
                        </div>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </form>
                </div>
            </div>
        </div>
    </div> *@

   
    <!-- Modal Structure -->
    <div class="modal fade" id="dataModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
        
    <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Trade Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p><strong>Symbol:</strong> <span id="modalSymbol"></span></p>
                    <p><strong>Last Price:</strong> <span id="modalLastPrice"></span></p>

                    <!-- Tab Navigation for Market and Limit Order -->
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="market-tab" data-toggle="tab" href="#market">Market Alım</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="limit-tab" data-toggle="tab" href="#limit">Limit Emir</a>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="market">
                            <form class="mt-3">
                                <div class="form-group">
                                    <label>Miktar</label>
                                    <input type="number" class="form-control" id="marketAmount">
                                </div>
                                <p><strong>Toplam:</strong> <span id="marketTotal"></span></p>
                                <button class="btn btn-success" id="btnBuyMarket">Al</button>
                                <button class="btn btn-danger" id="btnSellMarket">Sat</button>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="limit">
                            <form class="mt-3">
                                <div class="form-group">
                                    <label>Fiyat</label>
                                    <input type="text" class="form-control" id="limitPrice">
                                </div>
                                <div class="form-group">
                                    <label>Miktar</label>
                                    <input type="text" class="form-control" id="limitAmount">
                                </div>
                                <div class="form-group">
                                    <label>Toplam</label>
                                    <input type="text" class="form-control" id="limitTotal">
                                </div>
                                <button class="btn btn-success" id="btnBuyLimit">Al</button>
                                <button class="btn btn-danger" id="btnSellLimit">Sat</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        $(document).ready(function () {
           
            var currentTickers = {};
            var currentModalTicker = null;

            // WebSocket bağlantısı
            const socket = new WebSocket('wss://stream.binance.com:9443/ws/!ticker@arr');

            socket.onmessage = function (event) {
                var tickers = JSON.parse(event.data);
                updateTableData(tickers);

                

                tickers.forEach(function (ticker) {
                    // Sadece belirli hedef para birimleri için işle
                    var targetCurrency = ticker.s.substr(-4); // Paritenin son 4 karakterini al
                    var isTargetCurrency = ['USDT'].includes(targetCurrency);


                    // if (alarmPrice == tickers.c) {
                    //     alert('Alarm fiyatına ulaşıldı!');
                    // }

                
                    // Ayrıca, BTC ve ETH için özel bir kontrol yap
                    if (!isTargetCurrency) {
                        targetCurrency = ticker.s.substr(-3); // Son 3 karakteri dene
                        isTargetCurrency = ['BTC', 'ETH', 'TRY'].includes(targetCurrency);
                    }

                    if (isTargetCurrency) {
                        // Bu kısım yukarıdaki kodla aynı
                        currentTickers[ticker.s] = ticker;
                        var existingRow = dataTable.row('#' + ticker.s);

                        if (existingRow.length) {
                            existingRow.data([
                                ticker.s,
                                ticker.p,
                                ticker.P,
                                ticker.c
                            ]).draw(false);
                        } else {
                            dataTable.row.add([
                                ticker.s,
                                ticker.p,
                                ticker.P,
                                ticker.c
                            ]).node().id = ticker.s;
                            dataTable.draw(false);
                        }

                        // Eğer modal açıksa ve güncellenen ticker, modalda gösterilen ticker ise
                        if ($('#dataModal').hasClass('show') && currentModalTicker === ticker.s) {
                            updateModalData(ticker);
                        }
                    }
                });
            };


            function updateTableRowColor(row, oldData, newData) {
                var cells = row.nodes().to$().find('td');
                for (var i = 0; i < newData.length; i++) {
                    if (parseFloat(newData[i]) > parseFloat(oldData[i])) {
                        $(cells[i]).addClass('increase').removeClass('decrease');
                    } else if (parseFloat(newData[i]) < parseFloat(oldData[i])) {
                        $(cells[i]).addClass('decrease').removeClass('increase');
                    }
                }
            }

            function updateTableData(tickers) {
                tickers.forEach(function (ticker) {
                    var existingRow = dataTable.row('#' + ticker.s);
                    if (existingRow.length) {
                        var oldData = existingRow.data();
                        var newData = [
                            ticker.s, // Sembol
                            ticker.p, // Fiyat Değişimi
                            ticker.P, // Fiyat Değişimi (%)
                            ticker.c  // Fiyat
                        ];

                        // Yeni verilerle satırı güncelle
                        existingRow.data(newData).draw(false);

                        // Her hücre için renk güncellemesi yap
                        updateTableRowColor(existingRow, oldData, newData);
                    }
                });
            }



            // Modal içeriğini güncelle
            function updateModalData(ticker) {
                $('#modalSymbol').text(ticker.s);
                $('#modalLastPrice').text(ticker.c);
            }

            // Miktar girişi için event handler
            $('#marketAmount').on('input', function () {
                var amount = $(this).val();
                var price = parseFloat($('#modalLastPrice').text());
                var total = amount * price;
                $('#marketTotal').text(total.toFixed(2));
            });

            $('#btnBuyMarket').on('click', function () {
                var symbol = $('#modalSymbol').text();
                var count = parseFloat($('#marketAmount').val());
                var price = $('#modalLastPrice').text();
                postBuyMarket(symbol, count, price);
            });

            $('#btnSellMarket').on('click', function () {
                var symbol = $('#modalSymbol').text();
                var count = parseFloat($('#marketAmount').val());
                var price = $('#modalLastPrice').text();
                postSellMarket(symbol, count, price);
            });

            $('#btnBuyLimit').on('click', function () {
                var symbol = $('#modalSymbol').text();
                var count = parseFloat($('#limitAmount').val());
                var limitPrice = parseFloat($('#limitPrice').val());

                checkPriceAndExecuteOrder(symbol, limitPrice, count);
            });



            function checkPriceAndExecuteOrder(symbol, limitPrice, count) {
                var livePrice = getCurrentLivePrice(symbol); // Canlı fiyatı alın

                if (limitPrice === livePrice) {
                    // Fiyatlar eşitse, market alımı yap
                    postBuyMarket(symbol, count, livePrice);
                    updateWaitingTrade(symbol, false); // WaitingTrade kolonunu false olarak güncelle
                } else {
                    // Fiyatlar eşit değilse, WaitingTrade'i true yap ve beklemeye başla
                    updateWaitingTrade(symbol, true);
                    waitForPriceMatch(symbol, limitPrice, count);
                }
            }

            function waitForPriceMatch(symbol, limitPrice, count) {
                var interval = setInterval(function () {
                    var livePrice = getCurrentLivePrice(symbol);
                    if (livePrice === limitPrice) {
                        clearInterval(interval); // Eşleşme sağlandığında interval'ı durdur
                        postBuyMarket(symbol, count, livePrice);
                        updateWaitingTrade(symbol, false); // WaitingTrade kolonunu false olarak güncelle
                    }
                }, 1000); // Her 1 saniyede fiyat kontrolü (bu süreyi ihtiyaca göre ayarlayabilirsiniz)
            }




            $('#btnSellLimit').on('click', function () {
                var symbol = $('#modalSymbol').text();
                var count = parseFloat($('#limitAmount').val());
                var price = $('#modalLastPrice').text();
                postBuyLimit(symbol, count, price);
            });

            // Limit Emir sekmesine geçildiğinde ve modal açıldığında fiyatı güncelle
            function updateLimitPrice() {
                var currentPrice = $('#modalLastPrice').text();
                $('#limitPrice').val(currentPrice);
            }

            // Limit Emir sekmesine geçiş yapıldığında fiyatı güncelle
            $('#limit-tab').on('shown.bs.tab', function (e) {
                updateLimitPrice();
            });

            // Modal açıldığında fiyatı güncelle
            $('#dataModal').on('shown.bs.modal', function (e) {
                if ($('#limit-tab').hasClass('active')) {
                    updateLimitPrice();
                }
            });


            // Limit emir Toplamı hesapla ve göster
            function updateTotal() {
                var price = parseFloat($('#limitPrice').val());
                var amount = parseFloat($('#limitAmount').val());

                if (!isNaN(price) && !isNaN(amount)) {
                    var total = price * amount;
                    $('#limitTotal').val(total.toFixed(2));
                } else {
                    $('#limitTotal').val('');
                }
            }

            // Miktar veya Fiyat değiştiğinde Toplamı güncelle
            $('#limitPrice, #limitAmount').on('input', function () {
                updateTotal();
            });


            // Satıra tıklama işlevselliği
            $('#eventDataTable tbody').on('click', 'tr', function () {
                var data = dataTable.row(this).data();
                currentModalTicker = data[0]; // Şu anki modal ticker'ı güncelle
                updateModalData(currentTickers[currentModalTicker]);
                $('#dataModal').modal('show');
                $('#market-tab').tab('show');
            });

            $('#pairSelect').on('change', function () {
                var selectedPair = $(this).val();
                dataTable.column(0).search(selectedPair ? selectedPair + '$' : '', true, false).draw();
            });




            // let alarmPrice = null;

            // $('#alarmForm').on('submit', function (e) {
            //     e.preventDefault(); // Formun normal gönderimini engeller
            //     alarmPrice = $('#priceInput').val(); // Fiyatı alır
            //     $('#alarmModal').modal('hide'); // Modalı kapatır
            //     console.log('Alarm fiyatı ayarlandı:', alarmPrice);
            //     // Burada alarmPrice'ı daha sonra kullanmak üzere saklayabilirsiniz
            // });


            socket.onerror = function (error) {
                console.log('WebSocket Error: ' + error);
            };


        });
        

     


        function postBuyMarket(symbol, count, price) {
            var postData = {
                Symbol: symbol,
                Count: count,
                Price: price
            };

            $.ajax({
                url: '/Market/BuyMarket',
                method: 'POST',
                data: postData,
                success: function (response) {
                    if (response.IsSuccess) {
                        alert("Başarılı: " + response.Message);
                        Swal.fire({
                            title: 'Başarılı!',
                            text: response.Message,
                            icon: 'success',
                            confirmButtonText: 'Tamam'
                        });
                    } else {
                        alert("Hata: " + response.message);
                        Swal.fire({
                            title: 'Hata!',
                            text: response.message,
                            icon: 'error',
                            confirmButtonText: 'Tamam'
                        });
                    }
                },
                error: function (error) {
                    console.error("Hata: ", error);
                }
            });


        }


        function postSellMarket(symbol, count, price) {
            var postData = {
                Symbol: symbol,
                Count: count,
                Price: price
            };


            $.ajax({
                url: '/Market/SellMarket',
                method: 'POST',
                data: postData,
                success: function (response) {
                    if (response.IsSuccess) {
                        alert("Başarılı: " + response.Message);
                        Swal.fire({
                            title: 'Başarılı!',
                            text: response.Message,
                            icon: 'success',
                            confirmButtonText: 'Tamam'
                        });
                    } else {
                        alert("Hata: " + response.message);
                        Swal.fire({
                            title: 'Hata!',
                            text: response.message,
                            icon: 'error',
                            confirmButtonText: 'Tamam'
                        });
                    }
                },
                error: function (error) {
                    console.error("Hata: ", error);
                }
            });


        }

        function postBuyLimit(symbol, count, price) {
            var postData = {
                Symbol: symbol,
                Count: count,
                Price: price
            };

            $.ajax({
                url: '/Market/BuyLimit',
                method: 'POST',
                data: postData,
                success: function (response) {
                    if (response.IsSuccess) {
                        alert("Başarılı: " + response.Message);
                        Swal.fire({
                            title: 'Başarılı!',
                            text: response.Message,
                            icon: 'success',
                            confirmButtonText: 'Tamam'
                        });
                    } else {
                        alert("Hata: " + response.Message);
                        Swal.fire({
                            title: 'Hata!',
                            text: response.Message,
                            icon: 'error',
                            confirmButtonText: 'Tamam'
                        });
                    }
                },
                error: function (error) {
                    console.error("Hata: ", error);
                }
            });


        }


        function postBuyLimit(symbol, count, price) {
            var postData = {
                Symbol: symbol,
                Count: count,
                Price: price
            };

            $.ajax({
                url: '/Market/SellLimit',
                method: 'POST',
                data: postData,
                success: function (response) {
                    if (response.IsSuccess) {
                        alert("Başarılı: " + response.Message);
                        Swal.fire({
                            title: 'Başarılı!',
                            text: response.Message,
                            icon: 'success',
                            confirmButtonText: 'Tamam'
                        });
                    } else {
                        alert("Hata: " + response.message);
                        Swal.fire({
                            title: 'Hata!',
                            text: response.message,
                            icon: 'error',
                            confirmButtonText: 'Tamam'
                        });
                    }
                },
                error: function (error) {
                    console.error("Hata: ", error);
                }
            });


        }
         
    </script>

    <!-- Bootstrap JS for Modal -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
